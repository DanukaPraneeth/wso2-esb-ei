<?xml version="1.0" encoding="UTF-8"?>
<sequence name="com.apigate.omoney.merchantPaymentRequest" onError="com.apigate.omoney.faultSequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property name="query" value="*********** recieved the web payment request *************"/>
    </log>
    <property name="uri.var.omoney_backend.name" scope="default" type="STRING" value="webpayment"/>

    <property expression="get-property('registry', 'conf:/omoney_config.xml')" name="xmlFile" scope="default" type="OM" xmlns:ns="http://org.apache.synapse/xsd"/>
    <property expression="$ctx:xmlFile//merchant_key" name="reg_merchant_key" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <property expression="$ctx:xmlFile//security/consumer_key" name="reg_consumer_key" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>
    <property expression="$ctx:xmlFile//endPoints/notify" name="reg_notify" scope="default" type="STRING" xmlns:ns="http://org.apache.synapse/xsd"/>

    <property expression="json-eval($.)" name="payload" scope="default" type="STRING"/>
    <property expression="json-eval($.currency)" name="currency" scope="default" type="STRING"/>
    <property expression="json-eval($.order_id)" name="order_id" scope="default" type="STRING"/>
    <property expression="json-eval($.amount)" name="amount" scope="default" type="FLOAT"/>
    <property expression="json-eval($.lang)" name="language" scope="default" type="STRING"/>
    <property expression="json-eval($.reference)" name="reference" scope="default" type="STRING"/>
    <property expression="json-eval($.notif_url)" name="notif_url" scope="default" type="STRING"/>

    <log level="custom">
        <property expression="$ctx:order_id" name="payment ID" xmlns:ns="http://org.apache.synapse/xsd"/>
        <property expression="$ctx:amount" name="payment amount" xmlns:ns="http://org.apache.synapse/xsd"/>
    </log>
    <dbreport>
        <connection>
            <pool>
                <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
            </pool>
        </connection>
        <statement>
            <sql><![CDATA[insert into OMONEY_LOG (ORDER_ID, CURRENCY, AMOUNT, LANG, REFERENCE, NOTIFY_URL, PAYLOAD) values ( ?,?,?,?,?,?,? )]]></sql>
            <parameter expression="$ctx:order_id" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:currency" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:amount" type="FLOAT" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:language" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:reference" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:notif_url" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:payload" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
        </statement>
    </dbreport>
    <dblookup>
        <connection>
            <pool>
                <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
            </pool>
        </connection>
        <statement>
            <sql><![CDATA[ SELECT * FROM OMONEY_KEYS WHERE STATUS= ? ORDER BY ID DESC LIMIT 1 ]]></sql>
            <parameter name="STATUS" value="ACTIVE" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <result column="ACCESS_TOKEN" name="access_token"/>
        </statement>
    </dblookup>
    <log category="DEBUG" level="custom">
        <property expression="$ctx:access_token" name="active access token" xmlns:ns="http://org.apache.synapse/xsd"/>
    </log>

    <property xmlns:ns="http://org.apache.synapse/xsd"
              name="Authorization"
              expression="fn:concat('Basic ', get-property('access_token'))"
              scope="transport"/>

    <enrich>
        <source clone="true" type="inline">
            <merchant_key xmlns=""/>
        </source>
        <target action="child" xmlns:ns="http://org.apache.synapse/xsd" xpath="//jsonObject"/>
    </enrich>
    <enrich>
        <source clone="true" property="reg_merchant_key" type="property"/>
        <target xmlns:ns="http://org.apache.synapse/xsd" xpath="//merchant_key"/>
    </enrich>
    <enrich>
        <source clone="true" property="reg_notify" type="property"/>
        <target xmlns:ns="http://org.apache.synapse/xsd" xpath="//notif_url"/>
    </enrich>
    <enrich>
        <source clone="true" xmlns:ns="http://org.apache.synapse/xsd" xpath="//jsonObject"/>
        <target type="body"/>
    </enrich>
    <log category="DEBUG" level="custom">
        <property value="completed successfully" name="Web payment database update" xmlns:ns="http://org.apache.synapse/xsd"/>
    </log>
    <send>
        <endpoint key="nodeRedEnd"/>
    </send>
</sequence>