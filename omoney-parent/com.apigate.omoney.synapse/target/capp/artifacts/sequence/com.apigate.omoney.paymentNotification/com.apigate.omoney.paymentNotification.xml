<?xml version="1.0" encoding="UTF-8"?>
<sequence name="com.apigate.omoney.paymentNotification" onError="com.apigate.omoney.faultSequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="full">
        <property name="query" value="*********** recieved the web payment notification *************"/>
    </log>

    <property expression="json-eval($.status)" name="payment_status" scope="default" type="STRING"/>
    <property expression="json-eval($.notif_token)" name="notif_token" scope="default" type="STRING"/>
    <property expression="json-eval($.txnid)" name="txnid" scope="default" type="STRING"/>

    <property name="HTTP_SC" value="204" scope="axis2"/>
    <property name="FORCE_SC_ACCEPTED" value="true" scope="axis2" />

    <dbreport>
        <connection>
            <pool>
                <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
            </pool>
        </connection>
        <statement>
            <sql><![CDATA[UPDATE OMONEY_LOG SET STATUS = ?, TXNID = ? WHERE NOTIFY_TOKEN = ?]]></sql>
            <parameter expression="$ctx:payment_status" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:txnid" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <parameter expression="$ctx:notif_token" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
        </statement>
    </dbreport>

    <dblookup>
        <connection>
            <pool>
                <dsName>jdbc/WSO2TELCO_DEP_DB</dsName>
            </pool>
        </connection>
        <statement>
            <sql><![CDATA[ SELECT NOTIFY_URL FROM OMONEY_LOG WHERE NOTIFY_TOKEN= ? ]]></sql>
            <parameter expression="$ctx:notif_token" type="VARCHAR" xmlns:ns="http://org.apache.synapse/xsd"/>
            <result column="NOTIFY_URL" name="notify_url"/>
        </statement>
    </dblookup>

    <property name="uri.var.merchant.notif.endpoint" scope="default" type="STRING" expression="get-property('notify_url')"/>
    <property name="OUT_ONLY" scope="default" type="STRING" value="true"/>

    <send>
        <endpoint key="merchantEnd"/>
    </send>
    <drop/>
</sequence>